<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de NFe Avançada</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            transition: all 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .btn {
            @apply font-semibold rounded-full transition-colors duration-200;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00c4cc;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 flex items-center justify-center min-h-screen p-4">

    <!-- Main Container -->
    <div class="w-full max-w-2xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold text-slate-800 mb-2">Calculadora de NFe</h1>
            <p class="text-lg text-slate-500">Processe arquivos XML de NFe diretamente no seu navegador.</p>
        </header>

        <main class="space-y-6">
            <!-- Upload Section -->
            <div class="card upload-section text-center">
                <h2 class="text-2xl font-bold text-slate-700 mb-4">Selecione um Arquivo</h2>
                <p class="text-slate-500 mb-6">Escolha um arquivo XML de NFe para processar. Apenas arquivos `.xml` são suportados.</p>
                <input type="file" id="fileInput" accept=".xml" class="hidden">
                <label for="fileInput" class="cursor-pointer bg-sky-600 text-white py-3 px-8 rounded-full hover:bg-sky-700 transition-colors duration-200 shadow-lg transform hover:scale-105">
                    Escolher Arquivo
                </label>
                <button id="processButton" class="hidden mt-4 bg-lime-600 text-white py-3 px-8 rounded-full hover:bg-lime-700 transition-colors duration-200 shadow-lg">
                    Processar
                </button>
                <div id="loadingIndicator" class="loading-spinner mx-auto mt-4 hidden"></div>
            </div>

            <!-- Message/Error Box -->
            <div id="messageBox" class="card hidden p-4 flex items-center justify-between">
                <p id="messageText" class="text-sm font-medium"></p>
                <button onclick="document.getElementById('messageBox').style.display='none'" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>

            <!-- Results Section -->
            <div id="resultsCard" class="card results-section" style="display:none;">
                <h2 class="text-2xl font-bold text-slate-700 mb-4">Resultados da NF-e</h2>
                <pre id="resultsText" class="bg-gray-100 p-4 rounded-lg overflow-x-auto text-sm text-gray-800"></pre>
                <button id="downloadReportButton" class="btn hidden mt-6 bg-purple-600 text-white px-6 py-2 hover:bg-purple-700">
                    Baixar Dados para Relatório
                </button>
            </div>
        </main>
        
        <footer class="text-center mt-10 text-slate-400 text-sm">
            <p>&copy; 2023 Calculadora de NFe. Todos os direitos reservados.</p>
        </footer>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const processButton = document.getElementById('processButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const resultsCard = document.getElementById('resultsCard');
        const resultsText = document.getElementById('resultsText');
        const downloadReportButton = document.getElementById('downloadReportButton');

        function showMessage(message, type = 'info') {
            messageText.textContent = message;
            messageBox.style.display = 'flex';
            if (type === 'error') {
                messageBox.className = 'card bg-red-100 border border-red-400 text-red-700 mt-4 p-4 flex items-center justify-between';
            } else if (type === 'success') {
                messageBox.className = 'card bg-lime-100 border border-lime-400 text-lime-700 mt-4 p-4 flex items-center justify-between';
            } else {
                messageBox.className = 'card bg-sky-100 border border-sky-400 text-sky-700 mt-4 p-4 flex items-center justify-between';
            }
        }

        function toggleLoading(show) {
            loadingIndicator.style.display = show ? 'block' : 'none';
            processButton.disabled = show;
        }

        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (file) {
                processButton.style.display = 'block';
                resultsCard.style.display = 'none';
                messageBox.style.display = 'none';
                showMessage(`Arquivo selecionado: ${file.name}`, 'info');
            } else {
                processButton.style.display = 'none';
            }
        });

        processButton.addEventListener('click', () => {
            const file = fileInput.files[0];
            if (!file) {
                showMessage('Por favor, selecione um arquivo.', 'error');
                return;
            }

            const fileType = file.name.split('.').pop().toLowerCase();
            if (fileType !== 'xml') {
                showMessage('Apenas arquivos XML são suportados neste momento.', 'error');
                return;
            }

            toggleLoading(true);
            resultsCard.style.display = 'none';
            messageBox.style.display = 'none';

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const xmlText = e.target.result;
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, "application/xml");
                    
                    if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                        throw new Error("Erro ao analisar o arquivo XML.");
                    }

                    const namespaces = {
                        nfe: "http://www.portalfiscal.inf.br/nfe",
                        x: "http://www.w3.org/2000/xmlns/",
                    };

                    const findElement = (node, query) => {
                        const parts = query.split('/');
                        let currentNode = node;
                        for (const part of parts) {
                            const [nsPrefix, tagName] = part.split(':');
                            const ns = namespaces[nsPrefix];
                            if (ns) {
                                currentNode = currentNode?.getElementsByTagNameNS(ns, tagName)[0];
                            } else {
                                currentNode = currentNode?.getElementsByTagName(part)[0];
                            }
                            if (!currentNode) break;
                        }
                        return currentNode;
                    };

                    const emitente = findElement(xmlDoc, 'nfe:NFe/nfe:infNFe/nfe:emit/nfe:xNome')?.textContent || 'Não encontrado';
                    const numero_nf = findElement(xmlDoc, 'nfe:NFe/nfe:infNFe/nfe:ide/nfe:nNF')?.textContent || 'Não encontrado';
                    const serie_nf = findElement(xmlDoc, 'nfe:NFe/nfe:infNFe/nfe:ide/nfe:serie')?.textContent || 'Não encontrado';
                    
                    const items = [];
                    xmlDoc.querySelectorAll('det').forEach(det => {
                        const prod = det.querySelector('prod');
                        const imposto = det.querySelector('imposto');
                        
                        const valor_total = parseFloat(prod?.querySelector('vProd')?.textContent) || 0.0;
                        
                        // New, more robust search for taxes
                        const getTaxValue = (taxNode) => {
                            if (!taxNode) return 0.0;
                            // Search for common tax nodes inside the Imposto tag
                            const icmsNode = taxNode.querySelector('ICMS, ICMSSN102, ICMSSN900, ICMSSN500');
                            const ipiNode = taxNode.querySelector('IPI, IPITrib');
                            const pisNode = taxNode.querySelector('PIS, PISOutr');
                            const cofinsNode = taxNode.querySelector('COFINS, COFINSOutr');

                            // Extract values from various possible sub-tags
                            const icms = parseFloat(icmsNode?.querySelector('vICMS')?.textContent) || 0.0;
                            const ipi = parseFloat(ipiNode?.querySelector('vIPI')?.textContent) || 0.0;
                            const pis = parseFloat(pisNode?.querySelector('vPIS')?.textContent) || 0.0;
                            const cofins = parseFloat(cofinsNode?.querySelector('vCOFINS')?.textContent) || 0.0;

                            return { icms, ipi, pis, cofins };
                        };

                        const taxValues = getTaxValue(imposto);
                        const quantidade = parseFloat(prod?.querySelector('qCom')?.textContent) || 0.0;
                        const valor_liquido = valor_total - (taxValues.icms + taxValues.ipi + taxValues.pis + taxValues.cofins);
                        
                        items.push({
                            codigo: prod?.querySelector('cProd')?.textContent || 'Não disponível',
                            descricao: prod?.querySelector('xProd')?.textContent || 'Não disponível',
                            quantidade: quantidade,
                            valor_unitario: parseFloat(prod?.querySelector('vUnCom')?.textContent) || 0.0,
                            valor_total: valor_total,
                            icms: taxValues.icms,
                            ipi: taxValues.ipi,
                            pis: taxValues.pis,
                            cofins: taxValues.cofins,
                            valor_liquido: valor_liquido,
                            valor_liquido_unitario: quantidade > 0 ? valor_liquido / quantidade : 0.0
                        });
                    });

                    let result = `Emitente: ${emitente}\nNúmero da NF: ${numero_nf}\nSérie da NF: ${serie_nf}\n`;
                    result += '----------------------------------------------------------\n';
                    
                    if (items.length > 0) {
                        result += `Total de itens encontrados: ${items.length}\n`;
                        items.forEach((item, index) => {
                            result += `\nItem ${index + 1}:\n`;
                            result += `  Código: ${item.codigo}\n`;
                            result += `  Descrição: ${item.descricao}\n`;
                            result += `  Quantidade: ${item.quantidade}\n`;
                            result += `  Valor Unitário: R$${item.valor_unitario.toFixed(2)}\n`;
                            result += `  Valor Total: R$${item.valor_total.toFixed(2)}\n`;
                            result += `  ICMS: R$${item.icms.toFixed(2)}\n`;
                            result += `  IPI: R$${item.ipi.toFixed(2)}\n`;
                            result += `  PIS: R$${item.pis.toFixed(2)}\n`;
                            result += `  COFINS: R$${item.cofins.toFixed(2)}\n`;
                            result += `  Valor Líquido Unitário: R$${item.valor_liquido_unitario.toFixed(2)}\n`;
                            result += `  Valor Líquido Total: R$${item.valor_liquido.toFixed(2)}\n`;
                        });
                        sessionStorage.setItem('nfe_itens_json', JSON.stringify(items));
                        downloadReportButton.style.display = 'block';
                    } else {
                        result += '\nNenhuma informação detalhada de itens encontrada.';
                        sessionStorage.removeItem('nfe_itens_json');
                        downloadReportButton.style.display = 'none';
                    }

                    resultsText.textContent = result;
                    resultsCard.style.display = 'block';
                    showMessage('Arquivo processado com sucesso!', 'success');

                } catch (error) {
                    console.error("Erro no processamento:", error);
                    showMessage(`Erro ao processar o arquivo: ${error.message}`, 'error');
                } finally {
                    toggleLoading(false);
                }
            };

            reader.readAsText(file);
        });

        downloadReportButton.addEventListener('click', () => {
            const data = sessionStorage.getItem('nfe_itens_json');
            if (!data) {
                showMessage('Nenhum dado para baixar.', 'error');
                return;
            }

            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'nfe_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('Arquivo nfe_data.json baixado com sucesso!', 'info');
        });
    </script>
</body>
</html>

