<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de NFe Avançada</title>
    <!-- Google Fonts - Poppins para um visual moderno e arredondado -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .btn {
            @apply font-bold rounded-full transition-all duration-300 transform hover:scale-105;
        }
        .loading-spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #06b6d4; /* Tailwind's sky-500 */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .bg-gradient-background {
            background-image: linear-gradient(to bottom right, #e0f2fe, #f0f9ff);
        }
    </style>
</head>
<body class="bg-gradient-background flex items-center justify-center min-h-screen p-4 text-gray-800">

    <!-- Main Container -->
    <div class="w-full max-w-2xl">
        <header class="text-center mb-10">
            <h1 class="text-5xl md:text-6xl font-extrabold text-gray-800 mb-4 tracking-tight">Calculadora de NFe</h1>
            <p class="text-xl text-gray-600 font-medium">Processe arquivos XML de NFe em segundos, direto no seu navegador.</p>
        </header>

        <main class="space-y-8">
            <!-- Upload Section -->
            <div class="card upload-section text-center">
                <h2 class="text-3xl font-bold text-gray-700 mb-4">Selecione um Arquivo</h2>
                <p class="text-gray-500 mb-6 leading-relaxed">Clique no botão para escolher um arquivo XML de Nota Fiscal Eletrônica.</p>
                <input type="file" id="fileInput" accept=".xml" class="hidden">
                <label for="fileInput" class="cursor-pointer inline-block bg-sky-500 text-white py-3 px-10 rounded-full btn shadow-lg">
                    Escolher Arquivo
                </label>
                <button id="processButton" class="hidden mt-4 bg-lime-500 text-white py-3 px-10 rounded-full btn shadow-lg">
                    Processar
                </button>
                <div id="loadingIndicator" class="loading-spinner mx-auto mt-6 hidden"></div>
            </div>

            <!-- Message/Error Box -->
            <div id="messageBox" class="card hidden p-4 flex items-center justify-between text-left">
                <p id="messageText" class="text-sm font-semibold"></p>
                <button onclick="document.getElementById('messageBox').style.display='none'" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>

            <!-- Results Section -->
            <div id="resultsCard" class="card results-section" style="display:none;">
                <h2 class="text-3xl font-bold text-gray-700 mb-4">Resultados da NF-e</h2>
                <pre id="resultsText" class="bg-gray-50 p-6 rounded-xl overflow-x-auto text-sm text-gray-700 leading-6"></pre>
                <button id="downloadReportButton" class="btn hidden mt-6 bg-indigo-600 text-white px-8 py-3 shadow-lg">
                    Baixar Relatório em CSV
                </button>
            </div>
        </main>
        
        <footer class="text-center mt-12 text-gray-400 text-xs">
            <p>&copy; 2023 Calculadora de NFe. Todos os direitos reservados.</p>
        </footer>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const processButton = document.getElementById('processButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const resultsCard = document.getElementById('resultsCard');
        const resultsText = document.getElementById('resultsText');
        const downloadReportButton = document.getElementById('downloadReportButton');

        function showMessage(message, type = 'info') {
            messageText.textContent = message;
            messageBox.style.display = 'flex';
            if (type === 'error') {
                messageBox.className = 'card bg-red-100 border border-red-400 text-red-700 mt-4 p-4 flex items-center justify-between';
            } else if (type === 'success') {
                messageBox.className = 'card bg-lime-100 border border-lime-400 text-lime-700 mt-4 p-4 flex items-center justify-between';
            } else {
                messageBox.className = 'card bg-sky-100 border border-sky-400 text-sky-700 mt-4 p-4 flex items-center justify-between';
            }
        }

        function toggleLoading(show) {
            loadingIndicator.style.display = show ? 'block' : 'none';
            processButton.disabled = show;
        }

        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (file) {
                processButton.style.display = 'block';
                resultsCard.style.display = 'none';
                messageBox.style.display = 'none';
                showMessage(`Arquivo selecionado: ${file.name}`, 'info');
            } else {
                processButton.style.display = 'none';
            }
        });

        processButton.addEventListener('click', () => {
            const file = fileInput.files[0];
            if (!file) {
                showMessage('Por favor, selecione um arquivo.', 'error');
                return;
            }

            const fileType = file.name.split('.').pop().toLowerCase();
            if (fileType !== 'xml') {
                showMessage('Apenas arquivos XML são suportados neste momento.', 'error');
                return;
            }

            toggleLoading(true);
            resultsCard.style.display = 'none';
            messageBox.style.display = 'none';

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const xmlText = e.target.result;
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, "application/xml");
                    
                    if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                        throw new Error("Erro ao analisar o arquivo XML.");
                    }

                    const findElement = (node, query) => {
                        return node?.querySelector(query);
                    };

                    const findElements = (node, query) => {
                        return node?.querySelectorAll(query);
                    };
                    
                    const emitente = findElement(xmlDoc, 'xNome')?.textContent || 'Não encontrado';
                    const numero_nf = findElement(xmlDoc, 'nNF')?.textContent || 'Não encontrado';
                    const serie_nf = findElement(xmlDoc, 'serie')?.textContent || 'Não encontrado';
                    
                    const items = [];
                    let totalValorLiquido = 0;
                    let totalICMS = 0;
                    let totalIPI = 0;
                    let totalPIS = 0;
                    let totalCOFINS = 0;
                    
                    const detElements = findElements(xmlDoc, 'det');

                    detElements.forEach(det => {
                        const prod = findElement(det, 'prod');
                        const imposto = findElement(det, 'imposto');
                        
                        const valor_total = parseFloat(findElement(prod, 'vProd')?.textContent) || 0.0;
                        
                        // New, more robust search for taxes
                        const getTaxValue = (taxNode, tag) => {
                           return parseFloat(findElement(taxNode, tag)?.textContent) || 0.0;
                        };

                        const icms = getTaxValue(imposto, 'vICMS');
                        const ipi = getTaxValue(imposto, 'vIPI');
                        const pis = getTaxValue(imposto, 'vPIS');
                        const cofins = getTaxValue(imposto, 'vCOFINS');

                        const quantidade = parseFloat(findElement(prod, 'qCom')?.textContent) || 0.0;
                        const valor_liquido = valor_total - (icms + ipi + pis + cofins);

                        totalICMS += icms;
                        totalIPI += ipi;
                        totalPIS += pis;
                        totalCOFINS += cofins;
                        totalValorLiquido += valor_liquido;

                        items.push({
                            codigo: findElement(prod, 'cProd')?.textContent || 'Não disponível',
                            descricao: findElement(prod, 'xProd')?.textContent || 'Não disponível',
                            quantidade: quantidade,
                            valor_unitario: parseFloat(findElement(prod, 'vUnCom')?.textContent) || 0.0,
                            valor_total: valor_total,
                            icms: icms,
                            ipi: ipi,
                            pis: pis,
                            cofins: cofins,
                            valor_liquido: valor_liquido,
                            valor_liquido_unitario: quantidade > 0 ? valor_liquido / quantidade : 0.0
                        });
                    });

                    let result = `Emitente: ${emitente}\nNúmero da NF: ${numero_nf}\nSérie da NF: ${serie_nf}\n`;
                    result += '----------------------------------------------------------\n';
                    
                    if (items.length > 0) {
                        result += `Total de itens encontrados: ${items.length}\n`;
                        items.forEach((item, index) => {
                            result += `\nItem ${index + 1}:\n`;
                            result += `  Código: ${item.codigo}\n`;
                            result += `  Descrição: ${item.descricao}\n`;
                            result += `  Quantidade: ${item.quantidade}\n`;
                            result += `  Valor Unitário: R$${item.valor_unitario.toFixed(2)}\n`;
                            result += `  Valor Total: R$${item.valor_total.toFixed(2)}\n`;
                            result += `  ICMS: R$${item.icms.toFixed(2)}\n`;
                            result += `  IPI: R$${item.ipi.toFixed(2)}\n`;
                            result += `  PIS: R$${item.pis.toFixed(2)}\n`;
                            result += `  COFINS: R$${item.cofins.toFixed(2)}\n`;
                            result += `  Valor Líquido Unitário: R$${item.valor_liquido_unitario.toFixed(2)}\n`;
                            result += `  Valor Líquido Total: R$${item.valor_liquido.toFixed(2)}\n`;
                        });

                        // Add summary section
                        result += '\n----------------------------------------------------------\n';
                        result += 'RESUMO DA NOTA FISCAL\n';
                        result += '----------------------------------------------------------\n';
                        result += `Total de ICMS: R$${totalICMS.toFixed(2)}\n`;
                        result += `Total de IPI: R$${totalIPI.toFixed(2)}\n`;
                        result += `Total de PIS: R$${totalPIS.toFixed(2)}\n`;
                        result += `Total de COFINS: R$${totalCOFINS.toFixed(2)}\n`;
                        result += `Valor Líquido Total: R$${totalValorLiquido.toFixed(2)}\n`;
                        result += '----------------------------------------------------------\n';
                        
                        sessionStorage.setItem('nfe_itens_json', JSON.stringify(items));
                        downloadReportButton.style.display = 'block';
                    } else {
                        result += '\nNenhuma informação detalhada de itens encontrada.';
                        sessionStorage.removeItem('nfe_itens_json');
                        downloadReportButton.style.display = 'none';
                    }

                    resultsText.textContent = result;
                    resultsCard.style.display = 'block';
                    showMessage('Arquivo processado com sucesso!', 'success');

                } catch (error) {
                    console.error("Erro no processamento:", error);
                    showMessage(`Erro ao processar o arquivo: ${error.message}`, 'error');
                } finally {
                    toggleLoading(false);
                }
            };

            reader.readAsText(file);
        });

        downloadReportButton.addEventListener('click', () => {
            const items = JSON.parse(sessionStorage.getItem('nfe_itens_json'));
            if (!items || items.length === 0) {
                showMessage('Nenhum dado para baixar.', 'error');
                return;
            }

            const header = "Código;Descrição;Quantidade;Valor Unitário;Valor Total;ICMS;IPI;PIS;COFINS;Valor Líquido Unitário;Valor Líquido Total\n";
            let csvContent = header;

            items.forEach(item => {
                const row = [
                    `"${item.codigo}"`,
                    `"${item.descricao}"`,
                    item.quantidade.toFixed(2).replace('.', ','),
                    item.valor_unitario.toFixed(2).replace('.', ','),
                    item.valor_total.toFixed(2).replace('.', ','),
                    item.icms.toFixed(2).replace('.', ','),
                    item.ipi.toFixed(2).replace('.', ','),
                    item.pis.toFixed(2).replace('.', ','),
                    item.cofins.toFixed(2).replace('.', ','),
                    item.valor_liquido_unitario.toFixed(2).replace('.', ','),
                    item.valor_liquido.toFixed(2).replace('.', ',')
                ].join(';');
                csvContent += row + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'relatorio.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('Arquivo relatorio.csv baixado com sucesso!', 'success');
        });
    </script>
</body>
</html>
